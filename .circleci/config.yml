version: 2.1

jobs:
  # Builds
  buildBackend:
    docker:
      - image: circleci/python:3.6-node
    steps:
      - checkout
      - run:
          name: Install Top Level Dependencies
          command: yarn install
      - run:
          name: Install awscli
          command: sudo apt-get install -y awscli
      - run:
          name: make setup
          command: |
            cd cla-backend
            make setup_circle

  buildGoBackend:
    docker:
      - image: circleci/golang:1.11
    working_directory: /go/src/github.com/communitybridge/easycla/
    steps:
      - checkout
      - run:
          name: Setup
          command: |
            cd cla-backend-go
            make setup_dev
      - run:
          name: Build Swagger
          command: |
            cd cla-backend-go
            make swagger
      - run:
          name: Build
          command: |
            cd cla-backend-go
            make build_aws_lambda
      - run:
          name: Test
          command: |
            cd cla-backend-go
            make test
      #- run:
      #    name: Lint
      #    command: |
      #      cd cla-backend-go
      #      make lint

  buildUIProject: &buildUIAnchor
    docker:
      - image: circleci/node:8-browsers
    steps:
      - checkout
      - run:
          name: Install Top Level Dependencies
          command: yarn install
      - run:
          name: Install Dependencies
          command: cd $PROJECT_DIR && make setup

  buildProjectManagementConsole:
    <<: *buildUIAnchor
    environment:
      PROJECT_DIR: cla-frontend-project-console

  buildCorporateManagementConsole:
    <<: *buildUIAnchor
    environment:
      PROJECT_DIR: cla-frontend-corporate-console

  buildContributorConsole:
    <<: *buildUIAnchor
    environment:
      PROJECT_DIR: cla-frontend-contributor-console

workflows:
  version: 2.1
  build:
    jobs:
      - buildBackend:
          filters:
            tags:
              only: /.*/
      - buildGoBackend:
          filters:
            tags:
              only: /.*/
      - buildProjectManagementConsole:
          filters:
            tags:
              only: /.*/
      - buildCorporateManagementConsole:
          filters:
            tags:
              only: /.*/
      - buildContributorConsole:
          filters:
            tags:
              only: /.*/
